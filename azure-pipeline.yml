trigger:
  branches:
    include:
      - main # main 

variables:
  - group: Azurecredentials
  - name: acrName
    value: 'contactsaveracr1234'
  - name: containerImage
    value: 'contact-saver'
  - name: dockerfilePath
    value: 'backend'
  - name: tfBackendRg
    value: 'yousma-rg'
  - name: tfStorage
    value: 'yousmastorage'
  - name: tfContainer
    value: 'tfstate'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker Image to ACR
    jobs:
      - job: Build
        timeoutInMinutes: 20
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build and Push Docker Image
            inputs:
              containerRegistry: 'acr-connection1'  # must match service connection name
              repository: '$(containerImage)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)/Dockerfile'
              buildContext: '$(dockerfilePath)'
              tags: |
                latest

  - stage: Deploy
    displayName: Deploy Infrastructure and Container App
    dependsOn: BuildAndPush
    jobs:
      - job: TerraformDeploy
        displayName: Terraform Deploy Infra and Container App
        timeoutInMinutes: 40
        pool:
          vmImage: 'ubuntu-latest'
        steps:

          - task: AzureKeyVault@2
            displayName: Fetch EMAIL-API-KEY from Key Vault
            inputs:
              azureSubscription: 'Azure-Yousma-Connection'
              KeyVaultName: 'contactkv123'
              SecretsFilter: 'EMAIL-API-KEY'
              RunAsPreJob: true

          - task: TerraformInstaller@1
            displayName: Install Terraform
            inputs:
              terraformVersion: '1.6.6'

          - task: TerraformTaskV4@4
            displayName: Terraform Init
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'Azure-Yousma-Connection'
              backendAzureRmResourceGroupName: '$(tfBackendRg)'
              backendAzureRmStorageAccountName: '$(tfStorage)'
              backendAzureRmContainerName: '$(tfContainer)'
              backendAzureRmKey: 'terraform.tfstate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

          - task: TerraformTaskV4@4
            displayName: Terraform Plan
            inputs:
              provider: 'azurerm'
              command: 'plan'
              environmentServiceNameAzureRM: 'Azure-Yousma-Connection'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
              runAzLogin: true
              ensureBackend: true
              installTerraform: false
            env:
              TF_VAR_resource_group_name: $(tfBackendRg)
              TF_VAR_location: 'East US'
              TF_VAR_acr_name: $(acrName)
              TF_VAR_web_app_name: 'contact-saver-app'
              TF_VAR_key_vault_name: 'contactkv123'
              TF_VAR_email_api_key: $(EMAIL-API-KEY)
              TF_VAR_container_image: $(containerImage)

          - task: TerraformTaskV4@4
            displayName: Terraform Apply
            inputs:
              provider: 'azurerm'
              command: 'apply'
              environmentServiceNameAzureRM: 'Azure-Yousma-Connection'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
              commandOptions: '-auto-approve'
              runAzLogin: true
              ensureBackend: true
              installTerraform: false
            env:
              TF_VAR_resource_group_name: $(tfBackendRg)
              TF_VAR_location: 'East US'
              TF_VAR_acr_name: $(acrName)
              TF_VAR_web_app_name: 'contact-saver-app'
              TF_VAR_key_vault_name: 'contactkv123'
              TF_VAR_email_api_key: $(EMAIL-API-KEY)
              TF_VAR_container_image: $(containerImage)
