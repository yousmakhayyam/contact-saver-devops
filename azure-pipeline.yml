trigger:
  branches:
    include:
      - main

variables:
  - group: Azurecredentials
  - name: acrName
    value: 'contactsaveracr1234'
  - name: containerImage
    value: 'contact-saver'
  - name: dockerfilePath
    value: 'backend'
  - name: tfBackendRg
    value: 'yousma-rg'
  - name: tfStorage
    value: 'yousmastorage'
  - name: tfContainer
    value: 'tfstate'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker Image to ACR
    jobs:
      - job: Build
        timeoutInMinutes: 20
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build and Push Docker Image
            inputs:
              containerRegistry: 'acr-connection1'
              repository: '$(containerImage)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)/Dockerfile'
              buildContext: '$(dockerfilePath)'
              tags: |
                latest

  - stage: Deploy
    displayName: Deploy Infrastructure and Web App
    dependsOn: BuildAndPush
    jobs:
      - job: TerraformDeploy
        displayName: Terraform Deploy Infra and WebApp
        timeoutInMinutes: 40
        pool:
          vmImage: 'ubuntu-latest'
        steps:

          # ✅ Fetch secrets from Key Vault (NO envVariableMappings)
          - task: AzureKeyVault@2
            displayName: Fetch Secrets from Key Vault
            inputs:
              azureSubscription: 'Azure-Yousma-Connection'
              KeyVaultName: 'contactkv123'
              SecretsFilter: 'acr-admin-user,acr-admin-pass,EMAIL-API-KEY'
              RunAsPreJob: true

          # ✅ Install Terraform
          - task: TerraformInstaller@1
            displayName: Install Terraform
            inputs:
              terraformVersion: '1.6.6'

          # ✅ Terraform Init
          - task: TerraformTaskV4@4
            displayName: Terraform Init
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'Azure-Yousma-Connection'
              backendAzureRmResourceGroupName: '$(tfBackendRg)'
              backendAzureRmStorageAccountName: '$(tfStorage)'
              backendAzureRmContainerName: '$(tfContainer)'
              backendAzureRmKey: 'terraform.tfstate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

          # ✅ Terraform Plan with environment variables
          - task: TerraformTaskV4@4
            displayName: Terraform Plan
            inputs:
              provider: 'azurerm'
              command: 'plan'
              environmentServiceNameAzureRM: 'Azure-Yousma-Connection'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            env:
              TF_VAR_resource_group_name: $(tfBackendRg)
              TF_VAR_location: East US
              TF_VAR_acr_name: $(acrName)
              TF_VAR_web_app_name: contact-saver-app
              TF_VAR_key_vault_name: contactkv123
              TF_VAR_email_api_key: $(EMAIL_API_KEY)
              TF_VAR_container_image: $(containerImage)
              TF_VAR_app_service_plan_name: contact-plan
              TF_VAR_acr_admin_user: $(ACR_ADMIN_USER)
              TF_VAR_acr_admin_pass: $(ACR_ADMIN_PASS)

          # ✅ Terraform Apply with environment variables
          - task: TerraformTaskV4@4
            displayName: Terraform Apply
            inputs:
              provider: 'azurerm'
              command: 'apply'
              environmentServiceNameAzureRM: 'Azure-Yousma-Connection'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
              commandOptions: '-auto-approve'
              ensureBackend: true
              runAzLogin: true
              installTerraform: false
              allowTelemetryCollection: false
            env:
              TF_VAR_resource_group_name: $(tfBackendRg)
              TF_VAR_location: East US
              TF_VAR_acr_name: $(acrName)
              TF_VAR_web_app_name: contact-saver-app
              TF_VAR_key_vault_name: contactkv123
              TF_VAR_email_api_key: $(EMAIL_API_KEY)
              TF_VAR_container_image: $(containerImage)
              TF_VAR_app_service_plan_name: contact-plan
              TF_VAR_acr_admin_user: $(ACR_ADMIN_USER)
              TF_VAR_acr_admin_pass: $(ACR_ADMIN_PASS)
