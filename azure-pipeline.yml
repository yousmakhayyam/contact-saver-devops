trigger:
  branches:
    include:
      - main

variables:
  - group: Azurecredentials
  - name: acrName
    value: 'contactsaveracr1234'
  - name: containerImage
    value: 'contact-saver'
  - name: dockerfilePath
    value: 'backend'
  - name: tfBackendRg
    value: 'yousma-rg'
  - name: tfStorage
    value: 'yousmastorage'
  - name: tfContainer
    value: 'tfstate'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker Image to ACR
    jobs:
      - job: Build
        timeoutInMinutes: 20
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build and Push Docker Image
            inputs:
              containerRegistry: 'acr-connection1'
              repository: '$(containerImage)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)/Dockerfile'
              buildContext: '$(dockerfilePath)'
              tags: |
                latest

  - stage: Deploy
    displayName: Deploy Infrastructure and App
    dependsOn: BuildAndPush
    jobs:
      - job: TerraformDeploy
        displayName: Terraform Deploy Infra and WebApp
        timeoutInMinutes: 40
        pool:
          vmImage: 'ubuntu-latest'
        steps:

          - task: AzureKeyVault@2
            displayName: Fetch Secrets from Key Vault
            inputs:
              azureSubscription: 'Azure-Yousma-Connection'
              KeyVaultName: 'contactkv123'
              SecretsFilter: 'acr-admin-user,acr-admin-pass,EMAIL-API-KEY'
              RunAsPreJob: true

          - task: TerraformInstaller@1
            displayName: Install Terraform
            inputs:
              terraformVersion: '1.6.6'

          - task: TerraformTaskV4@4
            displayName: Terraform Init
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: 'Azure-Yousma-Connection'
              backendAzureRmResourceGroupName: '$(tfBackendRg)'
              backendAzureRmStorageAccountName: '$(tfStorage)'
              backendAzureRmContainerName: '$(tfContainer)'
              backendAzureRmKey: 'terraform.tfstate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'

          - task: TerraformTaskV4@4
            displayName: Terraform Plan
            inputs:
              provider: 'azurerm'
              command: 'plan'
              environmentServiceNameAzureRM: 'Azure-Yousma-Connection'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
              vars: |
                resource_group_name=$(tfBackendRg)
                location=East US
                acr_name=$(acrName)
                web_app_name=contact-saver-app
                key_vault_name=contactkv123
                email_api_key=$(EMAIL_API_KEY)
                container_image=$(containerImage)
                app_service_plan_name=contact-plan
                acr_admin_user=$(ACR_ADMIN_USER)
                acr_admin_pass=$(ACR_ADMIN_PASS)

          - task: TerraformTaskV4@4
            displayName: Terraform Apply
            inputs:
              provider: 'azurerm'
              command: 'apply'
              environmentServiceNameAzureRM: 'Azure-Yousma-Connection'
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
              vars: |
                resource_group_name=$(tfBackendRg)
                location=East US
                acr_name=$(acrName)
                web_app_name=contact-saver-app
                key_vault_name=contactkv123
                email_api_key=$(EMAIL_API_KEY)
                container_image=$(containerImage)
                app_service_plan_name=contact-plan
                acr_admin_user=$(ACR_ADMIN_USER)
                acr_admin_pass=$(ACR_ADMIN_PASS)
              ensureBackend: true
              commandOptions: '-auto-approve'
              allowTelemetryCollection: false
              runAzLogin: true
              installTerraform: false
